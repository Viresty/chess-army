import Head from 'next/head'
import { useEffect, useMemo, useState } from 'react'
import styles from '../styles/Home.module.scss'

import { ref, child, get, update, orderByChild, query, equalTo } from "firebase/database";
import { database } from "./api/firebase";

import Header from '../components/Header';
import LoadingScreen from '../components/LoadingScreen';

export default function Home() {
  const [accountInfo, setAccountInfo] = useState({});
  const [loadedData, setLoadedData] = useState(0);
  const [logedIn, setLogedin] = useState(false);

  async function getData() {
    let accountdata = JSON.parse(localStorage.getItem("accountInfo"));
    if (!accountdata) accountdata = JSON.parse(sessionStorage.getItem("accountInfo"));
    if (!accountdata) return;
    await get(query(ref(database, "user"), orderByChild("nickname"), equalTo(accountdata.nickname)))
      .then((snapshot) => {
        if (snapshot.exists()) {
          const data = snapshot.val().filter(x => x);
          if (data[0].password === accountdata.password) {
            setLogedin(true);
            setAccountInfo({ ...data });
          }
        } else {
          console.log("Can't found data");
        };
      })
      .catch((error) => {
        console.error(error);
      });

      setTimeout(() => {
        setLoadedData(1);
      }, 1000);
  }

  useEffect(() => {
    getData();
  }, []);

  const header = useMemo(() => {
    return <Header logedIn={logedIn} />
  }, [logedIn]);

  const renderLoadingScreen = useMemo(() => {
    return <LoadingScreen loaded={loadedData} />
  }, [loadedData]);

  return (
    <>
      <Head>
        <title>Chess Army</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <main className={styles.main}>
        {renderLoadingScreen}
        {header}
      </main>
    </>
  )
}
